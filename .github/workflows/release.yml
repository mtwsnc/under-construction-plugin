name: Create Release Package

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    name: Build and Package Plugin
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="dev-$(date +%Y%m%d-%H%M%S)"
          fi
          echo "VERSION=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create plugin package
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          # Create temporary directory
          mkdir -p under-construction-plugin

          # Copy plugin files (exclude development files)
          rsync -av --progress \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            --exclude='dist' \
            --exclude='package.sh' \
            --exclude='.github' \
            ./ under-construction-plugin/

          # Create zip file
          zip -r "under-construction-plugin-${VERSION}.zip" under-construction-plugin

          # Create checksums
          sha256sum "under-construction-plugin-${VERSION}.zip" > "under-construction-plugin-${VERSION}.zip.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: under-construction-plugin-${{ steps.get_version.outputs.VERSION }}
          path: |
            under-construction-plugin-*.zip
            under-construction-plugin-*.zip.sha256
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        with:
          files: |
            under-construction-plugin-*.zip
            under-construction-plugin-*.zip.sha256
          body: |
            ## Under Construction Plugin v${{ steps.get_version.outputs.VERSION }}

            ### Installation
            1. Download `under-construction-plugin-${{ steps.get_version.outputs.VERSION }}.zip`
            2. Go to WordPress Admin → Plugins → Add New → Upload Plugin
            3. Upload the zip file and activate
            4. Configure settings at Settings → Under Construction

            ### What's Included
            - Custom HTML and existing-page display modes
            - Administrator bypass with capability checks
            - Default responsive template and CodeMirror editor
            - Status code 503 handling for maintenance mode

            ### Verification
            SHA256 checksum is included in the release assets.

            For full documentation, see [README.md](https://github.com/mtwsnc/under-construction-plugin/blob/main/README.md)
          draft: false
          prerelease: false
